<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reaktivierungsanfragen - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li class="nav-dropdown">
                        <a href="#">Buchungen</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-bookings.html">üìÖ Alle Buchungen</a>
                            <a href="/admin-booking-approvals.html">‚úì Genehmigungen</a>
                            <a href="/admin-booking-times.html">‚è∞ Buchungszeiten</a>
                            <a href="/admin-blocked-dates.html">üö´ Gesperrte Tage</a>
                        </div>
                    </li>
                    <li class="nav-dropdown">
                        <a href="#">Benutzer</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-users.html">üë• Alle Benutzer</a>
                            <a href="/admin-color-requests.html">üé® Farb-Anfragen</a>
                            <a href="/admin-reactivation-requests.html">üîÑ Reaktivierungen</a>
                        </div>
                    </li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li id="super-admin-colors-link" style="display:none;"><a href="/admin-colors.html">üé® Farben</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 data-i18n="reactivation.manage_requests">Reaktivierungsanfragen</h1>

            <div id="alert-container"></div>

            <!-- Pending Requests -->
            <div id="requests-list"></div>
        </div>
    </main>

    <script src="/js/logo-banner.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sanitize.js"></script>
    <script src="/js/impersonation-banner.js"></script>
    <script>
        let requests = [];
        let allColors = [];

        // Load all available colors
        async function loadColors() {
            try {
                const response = await api.getColors();
                allColors = response.colors || [];
            } catch (error) {
                console.error('Failed to load colors:', error);
            }
        }

        // Get pattern icon for color badge
        function getPatternIcon(pattern) {
            const icons = {
                'circle': '‚óè', 'triangle': '‚ñ≤', 'square': '‚ñ†', 'diamond': '‚óÜ',
                'pentagon': '‚¨†', 'hexagon': '‚¨°', 'star': '‚òÖ', 'heart': '‚ô•',
                'cross': '‚úö', 'spade': '‚ô†', 'club': '‚ô£', 'moon': '‚òΩ',
                'sun': '‚òÄ', 'ring': '‚óã', 'target': '‚óé'
            };
            return icons[pattern] || '‚óè';
        }

        // Generate HTML for user's color badges
        function getUserColorsHtml(user) {
            if (!user || !user.colors || user.colors.length === 0) {
                return '<span style="color: #999;">Keine Farben</span>';
            }
            return user.colors.map(color => {
                const icon = getPatternIcon(color.pattern_icon);
                return `<span style="
                    display: inline-block;
                    padding: 2px 8px;
                    margin: 2px;
                    border-radius: 4px;
                    background: ${color.hex_code}20;
                    border: 1px solid ${color.hex_code};
                    color: ${color.hex_code};
                    font-size: 0.8rem;
                ">${icon} ${sanitizeHTML(color.name)}</span>`;
            }).join(' ');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                const userData = await api.getMe();
                if (!userData.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
                // Show colors link for super-admins
                if (userData.is_super_admin) {
                    const colorsLink = document.getElementById('super-admin-colors-link');
                    if (colorsLink) colorsLink.style.display = '';
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            // Initialize impersonation banner (shows if impersonating)
            await ImpersonationBanner.init();

            // Load colors, then requests
            await loadColors();
            loadRequests();
        });

        async function loadRequests() {
            try {
                requests = await api.getReactivationRequests();
                renderRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Anfragen');
            }
        }

        function renderRequests() {
            const container = document.getElementById('requests-list');

            if (requests.length === 0) {
                container.innerHTML = '<div class="card"><p data-i18n="reactivation.no_requests">Keine ausstehenden Anfragen</p></div>';
                return;
            }

            container.innerHTML = requests.map(request => {
                const safeUserName = request.user ? sanitizeHTML(`${request.user.first_name || ''} ${request.user.last_name || ''}`.trim()) : `User #${request.user_id}`;
                const safeEmail = request.user && request.user.email ? sanitizeHTML(request.user.email) : 'N/A';
                const safeDeactivationReason = request.user && request.user.deactivation_reason ? sanitizeHTML(request.user.deactivation_reason) : '';

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 10px 0;">${safeUserName}</h4>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>E-Mail:</strong> ${safeEmail}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Farben:</strong> ${getUserColorsHtml(request.user)}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Deaktiviert seit:</strong> ${request.user && request.user.deactivated_at ? new Date(request.user.deactivated_at).toLocaleDateString('de-DE') : 'N/A'}
                                </p>
                                ${request.user && request.user.deactivation_reason ? `
                                    <p style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                        <strong>Deaktivierungsgrund:</strong> ${safeDeactivationReason}
                                    </p>
                                ` : ''}
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Anfrage vom:</strong> ${new Date(request.created_at).toLocaleDateString('de-DE')}
                                </p>
                            </div>
                            ${request.status === 'pending' ? `
                                <div style="display: flex; gap: 5px; flex-direction: column; min-width: 120px;">
                                    <button class="btn btn-sm" onclick="approveRequest(${request.id})">Genehmigen</button>
                                    <button class="btn btn-danger btn-sm" onclick="denyRequest(${request.id})">Ablehnen</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function approveRequest(id) {
            const message = prompt('Optional: Nachricht an den Benutzer:');

            try {
                await api.approveReactivationRequest(id, message || null);
                showAlert('success', 'Anfrage genehmigt und Benutzer reaktiviert');
                loadRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Genehmigen');
            }
        }

        async function denyRequest(id) {
            const message = prompt('Optional: Nachricht an den Benutzer (Grund der Ablehnung):');

            if (!confirm('M√∂chtest du diese Reaktivierungsanfrage wirklich ablehnen?')) {
                return;
            }

            try {
                await api.denyReactivationRequest(id, message || null);
                showAlert('success', 'Anfrage abgelehnt');
                loadRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Ablehnen');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
