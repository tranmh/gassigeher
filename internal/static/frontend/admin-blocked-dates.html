<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesperrte Tage verwalten - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li class="nav-dropdown">
                        <a href="#">Buchungen</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-bookings.html">üìÖ Alle Buchungen</a>
                            <a href="/admin-booking-approvals.html">‚úì Genehmigungen</a>
                            <a href="/admin-booking-times.html">‚è∞ Buchungszeiten</a>
                            <a href="/admin-blocked-dates.html">üö´ Gesperrte Tage</a>
                        </div>
                    </li>
                    <li class="nav-dropdown">
                        <a href="#">Benutzer</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-users.html">üë• Alle Benutzer</a>
                            <a href="/admin-experience-requests.html">‚≠ê Level-Anfragen</a>
                            <a href="/admin-reactivation-requests.html">üîÑ Reaktivierungen</a>
                        </div>
                    </li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h1 data-i18n="admin.manage_blocked_dates">Gesperrte Tage verwalten</h1>
                <button class="btn" onclick="showBlockForm()" data-i18n="admin.block_date">Tag sperren</button>
            </div>

            <div id="alert-container"></div>

            <!-- Block Date Form -->
            <div id="block-form-container" class="card hidden" style="margin-bottom: 30px;">
                <h3 data-i18n="admin.block_date">Tag sperren</h3>
                <form id="block-form">
                    <div class="form-group">
                        <label data-i18n="bookings.date">Datum</label>
                        <input type="date" id="block-date" required>
                    </div>
                    <div class="form-group">
                        <label>Hund</label>
                        <select id="block-dog-id">
                            <option value="">Alle Hunde (globale Sperrung)</option>
                            <!-- Dog options populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="admin.block_reason">Grund der Sperrung</label>
                        <textarea id="block-reason" rows="3" required></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn" data-i18n="common.save">Speichern</button>
                        <button type="button" class="btn btn-secondary" onclick="hideBlockForm()" data-i18n="common.cancel">Abbrechen</button>
                    </div>
                </form>
            </div>

            <!-- Blocked Dates List -->
            <div id="blocked-dates-list"></div>
        </div>
    </main>

    <script src="/js/logo-banner.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sanitize.js"></script>
    <script src="/js/impersonation-banner.js"></script>
    <script>
        let blockedDates = [];
        let allDogs = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                const userData = await api.getMe();
                if (!userData.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            // Initialize impersonation banner (shows if impersonating)
            await ImpersonationBanner.init();

            await loadDogs();  // Load dogs for selector
            loadBlockedDates();

            document.getElementById('block-form').addEventListener('submit', handleBlockSubmit);
        });

        async function loadDogs() {
            try {
                allDogs = await api.getDogs();
                const dogSelect = document.getElementById('block-dog-id');
                dogSelect.innerHTML = '<option value="">Alle Hunde (globale Sperrung)</option>';
                allDogs.forEach(dog => {
                    dogSelect.innerHTML += `<option value="${dog.id}">${sanitizeHTML(dog.name)}</option>`;
                });
            } catch (error) {
                console.error('Failed to load dogs:', error);
            }
        }

        async function loadBlockedDates() {
            try {
                blockedDates = await api.getBlockedDates();
                renderBlockedDates();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der gesperrten Tage');
            }
        }

        function renderBlockedDates() {
            const container = document.getElementById('blocked-dates-list');

            if (blockedDates.length === 0) {
                container.innerHTML = '<div class="card"><p>Keine gesperrten Tage</p></div>';
                return;
            }

            container.innerHTML = blockedDates.map(blocked => {
                const dogDisplay = blocked.dog_id
                    ? `<span style="color: var(--primary-green);">üêï ${sanitizeHTML(blocked.dog_name || 'Unbekannter Hund')}</span>`
                    : '<span style="color: #888;">üåê Alle Hunde</span>';

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 10px 0;">üìÖ ${blocked.date}</h4>
                                <p style="margin: 0 0 5px 0; font-weight: bold;">${dogDisplay}</p>
                                <p style="margin: 0; color: #666;">${sanitizeHTML(blocked.reason)}</p>
                            </div>
                            <button class="btn btn-danger" onclick="unblockDate(${blocked.id})" data-i18n="admin.unblock_date">Aufheben</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showBlockForm() {
            document.getElementById('block-form').reset();
            document.getElementById('block-form-container').classList.remove('hidden');
        }

        function hideBlockForm() {
            document.getElementById('block-form-container').classList.add('hidden');
        }

        async function handleBlockSubmit(e) {
            e.preventDefault();

            const date = document.getElementById('block-date').value;
            const dogIdValue = document.getElementById('block-dog-id').value;
            const reason = document.getElementById('block-reason').value;

            const dogId = dogIdValue ? parseInt(dogIdValue) : null;

            try {
                const response = await api.createBlockedDate(date, reason, dogId);

                // Show success message with cancellation count
                let message = dogId ? 'Hund wurde gesperrt' : 'Tag wurde gesperrt';
                if (response.cancelled_bookings > 0) {
                    message += ` (${response.cancelled_bookings} ${response.cancelled_bookings === 1 ? 'Buchung wurde storniert' : 'Buchungen wurden storniert'})`;
                }

                showAlert('success', message);
                hideBlockForm();
                loadBlockedDates();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Sperren');
            }
        }

        async function unblockDate(id) {
            if (!confirm('M√∂chtest du die Sperrung aufheben?')) {
                return;
            }

            try {
                await api.deleteBlockedDate(id);
                showAlert('success', 'Sperrung aufgehoben');
                loadBlockedDates();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aufheben der Sperrung');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
