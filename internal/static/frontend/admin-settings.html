<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemeinstellungen - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li class="nav-dropdown">
                        <a href="#">Buchungen</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-bookings.html">üìÖ Alle Buchungen</a>
                            <a href="/admin-booking-approvals.html">‚úì Genehmigungen</a>
                            <a href="/admin-booking-times.html">‚è∞ Buchungszeiten</a>
                            <a href="/admin-blocked-dates.html">üö´ Gesperrte Tage</a>
                        </div>
                    </li>
                    <li class="nav-dropdown">
                        <a href="#">Benutzer</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-users.html">üë• Alle Benutzer</a>
                            <a href="/admin-experience-requests.html">‚≠ê Level-Anfragen</a>
                            <a href="/admin-reactivation-requests.html">üîÑ Reaktivierungen</a>
                        </div>
                    </li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container-narrow">
            <h1 data-i18n="admin_dashboard.system_settings">Systemeinstellungen</h1>

            <div id="alert-container"></div>

            <div class="card">
                <p data-i18n="admin_dashboard.settings_description">Systemweite Einstellungen verwalten</p>

                <!-- Booking Advance Days -->
                <div class="form-group">
                    <label data-i18n="admin_dashboard.booking_advance_days">Buchungsvorlauf (Tage)</label>
                    <input type="number" id="booking-advance-days" min="1" max="90">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Wie viele Tage im Voraus k√∂nnen Benutzer buchen?
                    </p>
                    <button class="btn" onclick="updateSetting('booking_advance_days', 'booking-advance-days')" style="margin-top: 10px;">Speichern</button>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

                <!-- Cancellation Notice Hours -->
                <div class="form-group">
                    <label data-i18n="admin_dashboard.cancellation_notice_hours">Stornierungsfrist (Stunden)</label>
                    <input type="number" id="cancellation-notice-hours" min="1" max="72">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Wie viele Stunden vor dem Spaziergang m√ºssen Benutzer stornieren?
                    </p>
                    <button class="btn" onclick="updateSetting('cancellation_notice_hours', 'cancellation-notice-hours')" style="margin-top: 10px;">Speichern</button>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

                <!-- Auto Deactivation Days -->
                <div class="form-group">
                    <label data-i18n="admin_dashboard.auto_deactivation_days">Auto-Deaktivierung (Tage)</label>
                    <input type="number" id="auto-deactivation-days" min="30" max="730">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Nach wie vielen Tagen Inaktivit√§t werden Benutzer automatisch deaktiviert?
                    </p>
                    <button class="btn" onclick="updateSetting('auto_deactivation_days', 'auto-deactivation-days')" style="margin-top: 10px;">Speichern</button>
                </div>
            </div>

            <!-- Registration Password Section -->
            <div class="card" style="margin-top: 30px;">
                <h2>Registrierungspasswort</h2>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
                    Dieses Passwort m√ºssen Benutzer bei der Registrierung eingeben.
                    Teilen Sie es nur mit vertrauensw√ºrdigen Personen.
                </p>

                <div class="form-group">
                    <label>Aktuelles Passwort</label>
                    <input type="text" id="registration-password"
                           style="font-family: monospace; font-size: 1.2rem; letter-spacing: 3px; text-transform: uppercase;"
                           maxlength="8" minlength="8"
                           pattern="[a-zA-Z0-9]{8}">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        8 alphanumerische Zeichen (Gro√ü-/Kleinbuchstaben und Zahlen)
                    </p>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="updateRegistrationPassword()">
                            Speichern
                        </button>
                        <button class="btn btn-secondary" onclick="generateNewPassword()" style="margin-left: 10px;">
                            Neues Passwort generieren
                        </button>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Group Section -->
            <div class="card" style="margin-top: 30px;">
                <h2>WhatsApp-Gruppe</h2>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
                    Aktivieren Sie die WhatsApp-Gruppe, damit neue Benutzer nach der Registrierung beitreten k√∂nnen.
                </p>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="whatsapp-enabled" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>WhatsApp-Gruppe aktivieren</span>
                    </label>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Wenn aktiviert, wird Benutzern ein Button zum Beitritt der WhatsApp-Gruppe angezeigt.
                    </p>
                </div>

                <div class="form-group" id="whatsapp-link-group" style="margin-top: 20px;">
                    <label>WhatsApp-Gruppen-Link</label>
                    <input type="url" id="whatsapp-link"
                           placeholder="https://chat.whatsapp.com/..."
                           style="font-family: monospace;">
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        So erhalten Sie den Link: WhatsApp √∂ffnen ‚Üí Gruppe ‚Üí Gruppeninfo ‚Üí Einladen √ºber Link ‚Üí Link kopieren
                    </p>
                </div>

                <div style="margin-top: 15px;">
                    <button class="btn" onclick="saveWhatsAppSettings()">
                        WhatsApp-Einstellungen speichern
                    </button>
                </div>
            </div>

            <!-- Site Logo Section -->
            <div class="card" style="margin-top: 30px;">
                <h2>Website-Logo</h2>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 20px;">
                    Laden Sie ein benutzerdefiniertes Logo hoch oder verwenden Sie das Standard-Logo.
                </p>

                <!-- Current Logo Preview -->
                <div class="form-group">
                    <label>Aktuelles Logo</label>
                    <div id="logo-preview-container" style="margin: 15px 0; text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 1px solid #e1e8e5;">
                        <img id="current-logo-preview"
                             src=""
                             alt="Aktuelles Logo"
                             style="max-height: 80px; max-width: 100%; height: auto;">
                    </div>
                </div>

                <!-- Upload Zone -->
                <div class="form-group">
                    <label>Neues Logo hochladen</label>
                    <div id="logo-upload-zone" style="border: 2px dashed #ccc; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s ease; background: #fafafa;">
                        <div id="logo-upload-prompt">
                            <span style="font-size: 2rem; display: block; margin-bottom: 10px;">üñºÔ∏è</span>
                            <p style="margin: 0; font-weight: 600; color: #333;">Logo hochladen</p>
                            <p style="margin: 5px 0 0; font-size: 0.85rem; color: #666;">Klicken oder Datei hierher ziehen</p>
                            <p style="margin: 5px 0 0; font-size: 0.8rem; color: #999;">JPEG oder PNG, max. 5 MB</p>
                        </div>
                        <input type="file" id="logo-file-input" accept=".jpg,.jpeg,.png" style="display: none;">
                    </div>
                </div>

                <!-- Reset Button -->
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="resetLogoToDefault()">
                        Standard-Logo verwenden
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/logo-banner.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script>
        let settings = {};

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                const userData = await api.getMe();
                if (!userData.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            loadSettings();
            loadCurrentLogo();
            setupLogoUpload();
            loadWhatsAppSettings();
        });

        async function loadSettings() {
            try {
                const settingsArray = await api.getSettings();

                // Convert array to object for easier access
                settingsArray.forEach(setting => {
                    settings[setting.key] = setting.value;
                });

                // Populate form fields
                document.getElementById('booking-advance-days').value = settings['booking_advance_days'] || '14';
                document.getElementById('cancellation-notice-hours').value = settings['cancellation_notice_hours'] || '12';
                document.getElementById('auto-deactivation-days').value = settings['auto_deactivation_days'] || '365';
                document.getElementById('registration-password').value = settings['registration_password'] || '';
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Einstellungen');
            }
        }

        async function updateSetting(key, inputId) {
            const value = document.getElementById(inputId).value;

            if (!value || value === '') {
                showAlert('error', 'Wert ist erforderlich');
                return;
            }

            try {
                await api.updateSetting(key, value);
                showAlert('success', 'Einstellung aktualisiert');
                settings[key] = value;
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktualisieren');
            }
        }

        async function updateRegistrationPassword() {
            const value = document.getElementById('registration-password').value.trim().toUpperCase();

            // Validate format
            if (!/^[a-zA-Z0-9]{8}$/.test(value)) {
                showAlert('error', 'Passwort muss genau 8 alphanumerische Zeichen enthalten');
                return;
            }

            try {
                await api.updateSetting('registration_password', value);
                showAlert('success', 'Registrierungspasswort aktualisiert');
                settings['registration_password'] = value;
                document.getElementById('registration-password').value = value;
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktualisieren');
            }
        }

        function generateNewPassword() {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            document.getElementById('registration-password').value = password;
            showAlert('success', 'Neues Passwort generiert. Klicken Sie "Speichern" um es zu √ºbernehmen.');
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // Logo Management Functions

        async function loadCurrentLogo() {
            try {
                const data = await api.getLogo();
                document.getElementById('current-logo-preview').src = data.logo_url;
            } catch (error) {
                console.error('Error loading logo:', error);
                // Use default logo on error
                document.getElementById('current-logo-preview').src = 'https://www.tierheim-goeppingen.de/wp-content/uploads/2017/04/Logo_4c_homepagebanner3.png';
            }
        }

        function setupLogoUpload() {
            const uploadZone = document.getElementById('logo-upload-zone');
            const fileInput = document.getElementById('logo-file-input');

            // Click to upload
            uploadZone.addEventListener('click', () => fileInput.click());

            // File selected
            fileInput.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    await uploadLogo(e.target.files[0]);
                    fileInput.value = ''; // Reset input
                }
            });

            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#82b965';
                uploadZone.style.background = '#f0f7ed';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = '#ccc';
                uploadZone.style.background = '#fafafa';
            });

            uploadZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = '#ccc';
                uploadZone.style.background = '#fafafa';
                if (e.dataTransfer.files.length > 0) {
                    await uploadLogo(e.dataTransfer.files[0]);
                }
            });
        }

        async function uploadLogo(file) {
            // Validate file type
            if (!file.type.match(/^image\/(jpeg|png)$/)) {
                showAlert('error', 'Nur JPEG und PNG Dateien sind erlaubt');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('error', 'Datei ist zu gross (max. 5 MB)');
                return;
            }

            try {
                const result = await api.uploadLogo(file);
                showAlert('success', 'Logo erfolgreich hochgeladen');
                document.getElementById('current-logo-preview').src = result.logo_url;
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Hochladen des Logos');
            }
        }

        async function resetLogoToDefault() {
            if (!confirm('M√∂chten Sie das Logo auf das Standard-Logo zur√ºcksetzen?')) {
                return;
            }

            try {
                const result = await api.resetLogo();
                showAlert('success', 'Logo auf Standard zur√ºckgesetzt');
                document.getElementById('current-logo-preview').src = result.logo_url;
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Zur√ºcksetzen des Logos');
            }
        }

        // WhatsApp Settings Functions
        async function loadWhatsAppSettings() {
            try {
                const data = await api.getWhatsAppSettings();
                document.getElementById('whatsapp-enabled').checked = data.enabled;
                document.getElementById('whatsapp-link').value = data.link || '';
                updateWhatsAppLinkVisibility();
            } catch (error) {
                console.error('Error loading WhatsApp settings:', error);
            }

            // Add event listener for toggle
            document.getElementById('whatsapp-enabled').addEventListener('change', updateWhatsAppLinkVisibility);
        }

        function updateWhatsAppLinkVisibility() {
            const enabled = document.getElementById('whatsapp-enabled').checked;
            const linkGroup = document.getElementById('whatsapp-link-group');
            linkGroup.style.opacity = enabled ? '1' : '0.5';
        }

        async function saveWhatsAppSettings() {
            const enabled = document.getElementById('whatsapp-enabled').checked;
            const link = document.getElementById('whatsapp-link').value.trim();

            // Validate link if enabled
            if (enabled && link && !link.startsWith('https://chat.whatsapp.com/')) {
                showAlert('error', 'WhatsApp-Link muss mit https://chat.whatsapp.com/ beginnen');
                return;
            }

            try {
                // Save enabled status
                await api.updateSetting('whatsapp_group_enabled', enabled ? 'true' : 'false');

                // Save link
                await api.updateSetting('whatsapp_group_link', link);

                showAlert('success', 'WhatsApp-Einstellungen gespeichert');
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Speichern der WhatsApp-Einstellungen');
            }
        }
    </script>
</body>
</html>
