<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Gassigeher</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <style>
        .color-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 4px;
            color: white;
        }
        .color-badge .pattern-icon {
            font-size: 0.8rem;
        }
        .color-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }
        .color-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .color-option:hover {
            border-color: #82b965;
            background: #f9f9f9;
        }
        .color-option.owned {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .color-option.owned::after {
            content: ' (bereits vorhanden)';
            font-size: 0.8rem;
            color: #666;
        }
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/dashboard.html" data-i18n="nav.dashboard">Dashboard</a></li>
                    <li><a href="/dogs.html" data-i18n="dogs.all_dogs">Hunde</a></li>
                    <li><a href="/calendar.html" data-i18n="nav.calendar">Kalender</a></li>
                    <li><a href="/profile.html" style="display: flex; align-items: center; gap: 8px;">
                        <span id="header-photo" style="width: 32px; height: 32px; border-radius: 50%; background: #ddd; display: inline-flex; align-items: center; justify-content: center; overflow: hidden;">üë§</span>
                        <span data-i18n="nav.profile">Profil</span>
                    </a></li>
                    <li id="admin-area-link" style="display: none;"><a href="/admin-dashboard.html" class="area-switcher" data-i18n="nav.admin_area">üîß Admin-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container-narrow">
            <h1 data-i18n="profile.title">Profil</h1>

            <div id="alert-container"></div>

            <!-- Profile Photo -->
            <div class="card">
                <h3>Profilfoto</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <div id="photo-preview" style="width: 150px; height: 150px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; background: #ddd; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 3rem;">üë§</span>
                    </div>
                    <input type="file" id="photo-input" accept="image/jpeg,image/png" style="display: none;" onchange="uploadPhoto()">
                    <button class="btn" onclick="document.getElementById('photo-input').click()">Foto hochladen</button>
                </div>
            </div>

            <!-- Profile Info -->
            <div class="card">
                <h3 data-i18n="profile.edit_profile">Profil bearbeiten</h3>
                <form id="profile-form">
                    <div class="form-group">
                        <label data-i18n="auth.first_name">Vorname</label>
                        <input type="text" id="display-first-name" readonly disabled
                               style="background: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.last_name">Nachname</label>
                        <input type="text" id="display-last-name" readonly disabled
                               style="background: #f0f0f0; cursor: not-allowed;">
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            Hinweis: Name kann nur vom Administrator ge√§ndert werden.
                        </p>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.email">E-Mail-Adresse</label>
                        <input type="email" id="edit-email" required>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            Hinweis: Bei √Ñnderung der E-Mail musst du diese erneut best√§tigen.
                        </p>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.phone">Telefonnummer</label>
                        <input type="tel" id="edit-phone" required
                               pattern="\+?[0-9\s\-\.\(\)]{7,20}"
                               placeholder="z.B. 0123 456789 oder +49 123 456789"
                               title="Bitte gib eine g√ºltige Telefonnummer ein (z.B. 0123 456789 oder +49 123 456789)">
                        <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                            Format: z.B. 0123 456789, +49 123 456789 oder 0123-456789
                        </p>
                    </div>
                    <button type="submit" class="btn" data-i18n="common.save">Speichern</button>
                </form>
            </div>

            <!-- User Colors -->
            <div class="card">
                <h3 data-i18n="colors.your_colors">Deine Farben</h3>
                <div id="user-colors-container">
                    <p data-i18n="colors.no_colors">Du hast noch keine Farbkategorien</p>
                </div>

                <div id="request-color-section" style="margin-top: 20px;">
                    <h4>Neue Farbe beantragen</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        W√§hle eine Farbe aus, um sie zu beantragen. Du kannst nur eine Anfrage gleichzeitig haben.
                    </p>
                    <div id="available-colors" class="color-grid"></div>
                    <div id="pending-request-notice" style="display: none; padding: 10px; background: #fff3cd; border-radius: 6px; margin-top: 10px;">
                        <strong>Hinweis:</strong> Du hast bereits eine ausstehende Anfrage.
                    </div>
                </div>
            </div>

            <!-- My Color Requests -->
            <div class="card">
                <h3 data-i18n="color_requests.title">Deine Farbanfragen</h3>
                <div id="my-requests"></div>
            </div>

            <!-- Change Password -->
            <div class="card">
                <h3 data-i18n="profile.change_password">Passwort √§ndern</h3>
                <form id="password-form">
                    <div class="form-group">
                        <label data-i18n="auth.old_password">Altes Passwort</label>
                        <input type="password" id="old-password" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.new_password">Neues Passwort</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="auth.confirm_new_password">Neues Passwort best√§tigen</label>
                        <input type="password" id="confirm-password" required>
                    </div>
                    <button type="submit" class="btn" data-i18n="auth.change_password">Passwort √§ndern</button>
                </form>
            </div>

            <!-- WhatsApp Group -->
            <div class="card" id="whatsapp-card" style="display: none; border-left: 4px solid #25d366;">
                <h3 style="color: #25d366;">üí¨ WhatsApp-Gruppe</h3>
                <p style="margin-bottom: 15px;">Tritt unserer WhatsApp-Gruppe bei, um auf dem Laufenden zu bleiben und dich mit anderen Gassigehern auszutauschen!</p>
                <a href="#" id="profile-whatsapp-btn" target="_blank" rel="noopener noreferrer"
                   style="display: inline-block; padding: 12px 25px; background-color: #25d366; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
                    WhatsApp-Gruppe beitreten
                </a>
            </div>

            <!-- Account Deletion (GDPR) - hidden for super-admins -->
            <div id="delete-account-section" class="card" style="border-left: 4px solid #dc3545;">
                <h3 style="color: #dc3545;" data-i18n="profile.delete_account">Konto l√∂schen</h3>
                <div style="background: #f8d7da; padding: 15px; border-radius: 6px; margin: 20px 0;">
                    <p style="margin: 0; color: #721c24; font-weight: 600;" data-i18n="profile.delete_account_warning">WARNUNG: Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
                </div>
                <p data-i18n="profile.delete_account_info">Deine pers√∂nlichen Daten werden gel√∂scht, aber deine Spaziergangshistorie wird anonymisiert aufbewahrt.</p>
                <button class="btn btn-danger" onclick="confirmDeleteAccount()" data-i18n="profile.delete_account">Konto l√∂schen</button>
            </div>
        </div>
    </main>

    <script src="/js/logo-banner.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sanitize.js"></script>
    <script src="/js/impersonation-banner.js"></script>
    <script>
        let currentUser = null;
        let userColors = [];
        let allColors = [];
        let myRequests = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            await window.i18n.load();
            window.i18n.updateElement(document.body);

            // Initialize impersonation banner (shows if impersonating)
            await ImpersonationBanner.init();

            try {
                // Load all data in parallel
                const [user, colorsResponse, requests] = await Promise.all([
                    api.getMe(),
                    api.getColors(),
                    api.getColorRequests()
                ]);

                currentUser = user;
                allColors = colorsResponse.colors || [];
                myRequests = requests;
                userColors = currentUser.colors || [];

                updateHeaderPhoto();
                showAdminLinkIfAdmin(currentUser);

                // Hide delete account section for super-admins (they cannot be deleted)
                if (currentUser.is_super_admin) {
                    const deleteSection = document.getElementById('delete-account-section');
                    if (deleteSection) deleteSection.style.display = 'none';
                }

                renderProfile();
                renderUserColors();
                renderAvailableColors();
                renderMyRequests();
                loadWhatsAppSettings();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden');
            }

            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);
            document.getElementById('password-form').addEventListener('submit', handlePasswordChange);

            // Check if redirected for mandatory password change
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('change_password') === 'true') {
                setTimeout(() => {
                    const passwordCard = document.getElementById('password-form').closest('.card');
                    if (passwordCard) {
                        passwordCard.style.border = '2px solid #ffc107';
                        passwordCard.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.3)';
                        passwordCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        showAlert('warning', 'Bitte √§ndere dein tempor√§res Passwort, um fortzufahren.');
                    }
                }, 500);
            }
        });

        function updateHeaderPhoto() {
            if (currentUser && currentUser.profile_photo) {
                const headerPhoto = document.getElementById('header-photo');
                headerPhoto.innerHTML = `<img src="/uploads/${currentUser.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="Profile">`;
            }
        }

        function renderProfile() {
            document.getElementById('display-first-name').value = currentUser.first_name || '';
            document.getElementById('display-last-name').value = currentUser.last_name || '';
            document.getElementById('edit-email').value = currentUser.email || '';
            document.getElementById('edit-phone').value = currentUser.phone || '';

            if (currentUser.profile_photo) {
                const photoPreview = document.getElementById('photo-preview');
                photoPreview.innerHTML = `<img src="/uploads/${currentUser.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;" alt="Profile">`;
            }
        }

        function renderUserColors() {
            const container = document.getElementById('user-colors-container');

            if (!userColors || userColors.length === 0) {
                container.innerHTML = '<p style="color: #666;">Du hast noch keine Farbkategorien. Beantrage unten eine Farbe!</p>';
                return;
            }

            container.innerHTML = `
                <div class="color-grid">
                    ${userColors.map(color => `
                        <span class="color-badge" style="background-color: ${color.hex_code};">
                            ${color.pattern_icon ? `<span class="pattern-icon">${getPatternEmoji(color.pattern_icon)}</span>` : ''}
                            ${getColorLabel(color.name)}
                        </span>
                    `).join('')}
                </div>
            `;
        }

        function renderAvailableColors() {
            const container = document.getElementById('available-colors');
            const pendingNotice = document.getElementById('pending-request-notice');

            // Check if user has a pending request
            const hasPendingRequest = myRequests.some(r => r.status === 'pending');
            pendingNotice.style.display = hasPendingRequest ? 'block' : 'none';

            // Get IDs of colors user already has
            const ownedColorIds = userColors.map(c => c.id);

            // Filter to colors user doesn't have
            const availableColors = allColors.filter(c => !ownedColorIds.includes(c.id));

            if (availableColors.length === 0) {
                container.innerHTML = '<p style="color: #28a745; font-weight: 600;">Du hast alle verf√ºgbaren Farben!</p>';
                return;
            }

            container.innerHTML = availableColors.map(color => `
                <div class="color-option ${hasPendingRequest ? 'owned' : ''}"
                     onclick="${hasPendingRequest ? '' : `requestColor(${color.id}, '${color.name}')`}"
                     style="${hasPendingRequest ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    <span class="color-swatch" style="background-color: ${color.hex_code};"></span>
                    <span>${getColorLabel(color.name)}</span>
                    ${color.pattern_icon ? `<span style="font-size: 0.8rem;">${getPatternEmoji(color.pattern_icon)}</span>` : ''}
                </div>
            `).join('');
        }

        function getColorLabel(name) {
            const labels = {
                'gruen': 'Gr√ºn',
                'gelb': 'Gelb',
                'orange': 'Orange',
                'hellblau': 'Hellblau',
                'dunkelblau': 'Dunkelblau',
                'helllila': 'Helllila',
                'dunkellila': 'Dunkellila'
            };
            return labels[name] || name;
        }

        function getPatternEmoji(pattern) {
            const patterns = {
                'circle': '‚óè',
                'triangle': '‚ñ≤',
                'square': '‚ñ†',
                'diamond': '‚óÜ',
                'pentagon': '‚¨†',
                'hexagon': '‚¨°',
                'star': '‚òÖ'
            };
            return patterns[pattern] || '';
        }

        async function requestColor(colorId, colorName) {
            if (!confirm(`M√∂chtest du "${getColorLabel(colorName)}" beantragen?`)) {
                return;
            }

            try {
                await api.createColorRequest(colorId);
                showAlert('success', 'Anfrage erfolgreich eingereicht');

                // Reload requests
                myRequests = await api.getColorRequests();
                renderAvailableColors();
                renderMyRequests();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Einreichen der Anfrage');
            }
        }

        function renderMyRequests() {
            const container = document.getElementById('my-requests');

            if (myRequests.length === 0) {
                container.innerHTML = '<p style="color: #666;">Keine Anfragen vorhanden</p>';
                return;
            }

            container.innerHTML = myRequests.map(request => {
                const statusClass = request.status === 'approved' ? 'alert-success' :
                                  (request.status === 'denied' ? 'alert-error' : 'alert-info');
                const statusLabel = getStatusLabel(request.status);
                const color = request.color || allColors.find(c => c.id === request.color_id);

                return `
                    <div class="card" style="margin-bottom: 15px; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    ${color ? `
                                        <span class="color-badge" style="background-color: ${color.hex_code}; margin: 0;">
                                            ${color.pattern_icon ? `<span class="pattern-icon">${getPatternEmoji(color.pattern_icon)}</span>` : ''}
                                            ${getColorLabel(color.name)}
                                        </span>
                                    ` : '<span>Unbekannte Farbe</span>'}
                                </div>
                                <p style="margin: 5px 0; font-size: 0.9rem;">
                                    Beantragt am: ${new Date(request.created_at).toLocaleDateString('de-DE')}
                                </p>
                                ${request.reviewed_at ? `<p style="margin: 5px 0; font-size: 0.9rem;">Gepr√ºft am: ${new Date(request.reviewed_at).toLocaleDateString('de-DE')}</p>` : ''}
                                ${request.admin_message ? `<p style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px;"><strong>Nachricht:</strong> ${sanitizeHTML(request.admin_message)}</p>` : ''}
                            </div>
                            <span class="alert ${statusClass}" style="padding: 6px 12px; font-size: 0.85rem; margin: 0;">${statusLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                pending: 'Ausstehend',
                approved: 'Genehmigt',
                denied: 'Abgelehnt'
            };
            return labels[status] || status;
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();

            const form = e.target;
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const email = document.getElementById('edit-email').value;
            const phone = document.getElementById('edit-phone').value;

            const phonePattern = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
            if (!phonePattern.test(phone)) {
                showAlert('error', 'Bitte gib eine g√ºltige Telefonnummer ein (z.B. 0123 456789 oder +49 123 456789)');
                return;
            }

            try {
                const response = await api.updateMe({ email, phone });
                showAlert('success', response.message || 'Profil aktualisiert');

                currentUser = await api.getMe();
                renderProfile();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktualisieren');
            }
        }

        async function uploadPhoto() {
            const fileInput = document.getElementById('photo-input');
            const file = fileInput.files[0];

            if (!file) return;

            if (!file.type.match(/image\/(jpeg|jpg|png)/)) {
                showAlert('error', 'Nur JPEG und PNG Dateien sind erlaubt');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showAlert('error', 'Datei zu gro√ü (max. 5MB)');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const photoPreview = document.getElementById('photo-preview');
                photoPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" alt="Preview">`;
            };
            reader.readAsDataURL(file);

            try {
                const response = await api.uploadPhoto(file);
                showAlert('success', 'Foto erfolgreich hochgeladen');
                currentUser = await api.getMe();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Hochladen');
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();

            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showAlert('error', 'Passw√∂rter stimmen nicht √ºberein');
                return;
            }

            try {
                await api.changePassword(oldPassword, newPassword, confirmPassword);
                showAlert('success', 'Passwort erfolgreich ge√§ndert');
                document.getElementById('password-form').reset();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim √Ñndern des Passworts');
            }
        }

        async function confirmDeleteAccount() {
            if (!confirm('WARNUNG: Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!\n\nDeine pers√∂nlichen Daten werden gel√∂scht, aber deine Spaziergangshistorie wird anonymisiert aufbewahrt.\n\nM√∂chtest du fortfahren?')) {
                return;
            }

            const password = prompt('Gib dein Passwort ein, um die L√∂schung zu best√§tigen:');
            if (!password) return;

            try {
                await api.deleteAccount(password);
                alert('Dein Konto wurde gel√∂scht. Du erh√§ltst eine Best√§tigungs-E-Mail.');
                api.setToken(null);
                window.location.href = '/';
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim L√∂schen des Kontos');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        async function loadWhatsAppSettings() {
            try {
                const whatsappData = await api.getWhatsAppSettings();
                if (whatsappData.enabled && whatsappData.link) {
                    const card = document.getElementById('whatsapp-card');
                    const btn = document.getElementById('profile-whatsapp-btn');
                    btn.href = whatsappData.link;
                    card.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading WhatsApp settings:', error);
            }
        }
    </script>
</body>
</html>
