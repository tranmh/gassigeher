<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benutzerverwaltung - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li class="nav-dropdown">
                        <a href="#">Buchungen</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-bookings.html">üìÖ Alle Buchungen</a>
                            <a href="/admin-booking-approvals.html">‚úì Genehmigungen</a>
                            <a href="/admin-booking-times.html">‚è∞ Buchungszeiten</a>
                            <a href="/admin-blocked-dates.html">üö´ Gesperrte Tage</a>
                        </div>
                    </li>
                    <li class="nav-dropdown">
                        <a href="#">Benutzer</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-users.html">üë• Alle Benutzer</a>
                            <a href="/admin-experience-requests.html">‚≠ê Level-Anfragen</a>
                            <a href="/admin-reactivation-requests.html">üîÑ Reaktivierungen</a>
                        </div>
                    </li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 data-i18n="users.title">Benutzerverwaltung</h1>

            <div id="alert-container"></div>

            <!-- Filters -->
            <div class="filter-bar">
                <h3 style="margin-bottom: 15px;">Filter</h3>
                <div class="filter-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filter-status">
                            <option value="">Alle</option>
                            <option value="active" data-i18n="users.status_active">Aktiv</option>
                            <option value="inactive" data-i18n="users.status_inactive">Inaktiv</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" onclick="applyFilters()" data-i18n="common.apply">Anwenden</button>
                    <button class="btn btn-secondary" onclick="showCreateModal()">+ Benutzer erstellen</button>
                </div>
            </div>

            <!-- Users List -->
            <div id="users-list"></div>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Benutzer bearbeiten</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form" onsubmit="saveUser(event)">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label for="edit-first-name">Vorname *</label>
                    <input type="text" id="edit-first-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-last-name">Nachname *</label>
                    <input type="text" id="edit-last-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">E-Mail *</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-phone">Telefon</label>
                    <input type="tel" id="edit-phone">
                </div>
                <div class="form-group">
                    <label for="edit-level">Erfahrungslevel *</label>
                    <select id="edit-level" required>
                        <option value="green">Gr√ºn (Anf√§nger)</option>
                        <option value="orange">Orange (Erfahren)</option>
                        <option value="blue">Blau (Nur feste Gassigeher)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Abbrechen</button>
                    <button type="submit" class="btn">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="create-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Benutzer erstellen</h3>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <form id="create-form" onsubmit="createUser(event)">
                <div class="form-group">
                    <label for="create-first-name">Vorname *</label>
                    <input type="text" id="create-first-name" required>
                </div>
                <div class="form-group">
                    <label for="create-last-name">Nachname *</label>
                    <input type="text" id="create-last-name" required>
                </div>
                <div class="form-group">
                    <label for="create-email">E-Mail *</label>
                    <input type="email" id="create-email" required>
                </div>
                <div class="form-group">
                    <label for="create-phone">Telefon</label>
                    <input type="tel" id="create-phone">
                </div>
                <div class="form-group">
                    <label for="create-level">Erfahrungslevel *</label>
                    <select id="create-level" required>
                        <option value="green">Gr√ºn (Anf√§nger)</option>
                        <option value="orange">Orange (Erfahren)</option>
                        <option value="blue">Blau (Nur feste Gassigeher)</option>
                    </select>
                </div>
                <div class="form-group" id="create-admin-group" style="display: none;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="create-is-admin" style="width: auto;">
                        <span>Als Administrator erstellen</span>
                    </label>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 5px;">
                        Admins erhalten automatisch Blau-Level und haben Zugang zu allen Verwaltungsfunktionen.
                    </p>
                </div>
                <div class="form-info" style="background: #e3f2fd; padding: 15px; border-radius: 6px; margin: 15px 0;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        <strong>Hinweis:</strong> Der Benutzer erh√§lt ein tempor√§res Passwort per E-Mail und muss dieses bei der ersten Anmeldung √§ndern.
                    </p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Abbrechen</button>
                    <button type="submit" class="btn">Benutzer erstellen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Benutzer l√∂schen</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="delete-user-id">
                <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                    <p style="margin: 0 0 10px 0; color: #721c24; font-weight: bold;">
                        Warnung: Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!
                    </p>
                    <p style="margin: 0; color: #721c24; font-size: 0.9rem;">
                        Der Benutzer <strong id="delete-user-name"></strong> wird unwiderruflich gel√∂scht.
                        Alle pers√∂nlichen Daten werden anonymisiert (DSGVO-konform).
                        Die Buchungshistorie bleibt erhalten, zeigt aber nur "Deleted User" an.
                    </p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Abbrechen</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">Endg√ºltig l√∂schen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/logo-banner.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sanitize.js"></script>
    <script src="/js/impersonation-banner.js"></script>
    <script>
        let users = [];
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                currentUser = await api.getMe();
                if (!currentUser.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            // Initialize impersonation banner (shows if impersonating)
            await ImpersonationBanner.init();

            loadUsers();
        });

        async function loadUsers() {
            try {
                const filterStatus = document.getElementById('filter-status').value;
                let activeOnly = null;
                if (filterStatus === 'active') activeOnly = true;
                if (filterStatus === 'inactive') activeOnly = false;

                users = await api.getUsers(activeOnly);
                renderUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Benutzer');
            }
        }

        function applyFilters() {
            loadUsers();
        }

        function renderUsers() {
            const container = document.getElementById('users-list');

            if (users.length === 0) {
                container.innerHTML = '<div class="card"><p>Keine Benutzer gefunden</p></div>';
                return;
            }

            container.innerHTML = users.map(user => {
                const statusClass = user.is_active ? 'alert-success' : 'alert-error';
                const statusLabel = user.is_active ? 'Aktiv' : 'Inaktiv';
                const levelLabel = getLevelLabel(user.experience_level);

                // Sanitize user data to prevent XSS
                const safeFirstName = sanitizeHTML(user.first_name || '');
                const safeLastName = sanitizeHTML(user.last_name || '');
                const safeName = `${safeFirstName} ${safeLastName}`.trim();
                const safeEmail = sanitizeHTML(user.email || 'N/A');
                const safePhone = sanitizeHTML(user.phone || 'N/A');
                const safeReason = user.deactivation_reason ? sanitizeHTML(user.deactivation_reason) : '';

                // Determine role badge
                let roleBadge = '';
                if (user.is_super_admin) {
                    roleBadge = '<span class="badge-super-admin">Super Admin</span>';
                } else if (user.is_admin) {
                    roleBadge = '<span class="badge-admin">Admin</span>';
                } else {
                    roleBadge = '<span class="badge-user">Benutzer</span>';
                }

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                                    <h4 style="margin: 0; white-space: nowrap;">${safeName}</h4>
                                    <span class="badge-status ${statusClass}">${statusLabel}</span>
                                    <span class="badge-level ${user.experience_level}">${levelLabel}</span>
                                    ${roleBadge}
                                </div>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>E-Mail:</strong> ${safeEmail}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Telefon:</strong> ${safePhone}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Letzte Aktivit√§t:</strong> ${user.last_activity_at ? new Date(user.last_activity_at).toLocaleDateString('de-DE') : 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Mitglied seit:</strong> ${new Date(user.created_at).toLocaleDateString('de-DE')}
                                </p>
                                ${user.deactivated_at && user.deactivation_reason ? `
                                    <p style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                        <strong>Deaktivierungsgrund:</strong> ${safeReason}
                                    </p>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 5px; flex-direction: column; min-width: 150px;">
                                ${!user.is_deleted ? `
                                    <button class="btn btn-secondary btn-sm" onclick="showEditModal(${user.id})">Bearbeiten</button>
                                ` : ''}
                                ${!user.is_admin && !user.is_super_admin && user.is_active ? `
                                    <button class="btn btn-danger btn-sm" onclick="deactivateUser(${user.id})">Deaktivieren</button>
                                ` : user.is_active && !user.is_super_admin ? `
                                    <button class="btn btn-sm" onclick="activateUser(${user.id})">Aktivieren</button>
                                ` : !user.is_active ? `
                                    <button class="btn btn-sm" onclick="activateUser(${user.id})">Aktivieren</button>
                                ` : ''}

                                ${currentUser && currentUser.is_super_admin && !user.is_super_admin ? `
                                    ${user.is_admin ? `
                                        <button class="btn btn-warning btn-sm" onclick="demoteAdmin(${user.id}, '${safeName.replace(/'/g, "\\'")}')">Admin entfernen</button>
                                    ` : `
                                        <button class="btn btn-secondary btn-sm" onclick="promoteToAdmin(${user.id}, '${safeName.replace(/'/g, "\\'")}')">Zu Admin ernennen</button>
                                    `}
                                    ${!user.is_deleted && user.is_active ? `
                                        <button class="btn btn-info btn-sm" onclick="impersonateUser(${user.id}, '${safeName.replace(/'/g, "\\'")}')">Impersonieren</button>
                                    ` : ''}
                                    ${!user.is_deleted ? `
                                        <button class="btn btn-danger btn-sm" onclick="showDeleteModal(${user.id}, '${safeName.replace(/'/g, "\\'")}')">L√∂schen</button>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getLevelLabel(level) {
            const labels = { green: 'Gr√ºn', blue: 'Blau', orange: 'Orange' };
            return labels[level] || level;
        }

        async function deactivateUser(id) {
            const reason = prompt('Grund f√ºr die Deaktivierung:');
            if (!reason) return;

            if (!confirm('Sind Sie sicher, dass Sie diesen Benutzer deaktivieren m√∂chten?')) {
                return;
            }

            try {
                await api.deactivateUser(id, reason);
                showAlert('success', 'Benutzer deaktiviert');
                loadUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Deaktivieren');
            }
        }

        async function activateUser(id) {
            const message = prompt('Optional: Nachricht an den Benutzer:');

            if (!confirm('M√∂chten Sie diesen Benutzer aktivieren?')) {
                return;
            }

            try {
                await api.activateUser(id, message || null);
                showAlert('success', 'Benutzer aktiviert');
                loadUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktivieren');
            }
        }

        async function promoteToAdmin(userId, userName) {
            if (!confirm(`M√∂chten Sie ${userName} wirklich zum Admin ernennen?\n\nAdmins haben Zugriff auf alle Verwaltungsfunktionen.`)) {
                return;
            }

            try {
                const result = await api.promoteToAdmin(userId);
                showAlert('success', `${userName} wurde erfolgreich zum Admin ernannt.`);
                loadUsers();
            } catch (error) {
                console.error('Error promoting user:', error);
                showAlert('error', error.message || 'Fehler beim Ernennen zum Admin');
            }
        }

        async function demoteAdmin(userId, userName) {
            if (!confirm(`M√∂chten Sie ${userName} wirklich die Admin-Rechte entziehen?\n\nDer Benutzer wird zu einem normalen Benutzer herabgestuft.`)) {
                return;
            }

            try {
                const result = await api.demoteAdmin(userId);
                showAlert('success', `Admin-Rechte von ${userName} wurden erfolgreich entzogen.`);
                loadUsers();
            } catch (error) {
                console.error('Error demoting admin:', error);
                showAlert('error', error.message || 'Fehler beim Entziehen der Admin-Rechte');
            }
        }

        async function impersonateUser(userId, userName) {
            if (!confirm(`M√∂chten Sie sich als "${userName}" anmelden?\n\nSie werden als dieser Benutzer agieren und k√∂nnen alle seine Funktionen nutzen.\nKlicken Sie auf "Zur√ºck zum Admin" um die Impersonation zu beenden.`)) {
                return;
            }

            try {
                const response = await api.impersonateUser(userId);
                if (response && response.token) {
                    // Set the new impersonation token
                    api.setToken(response.token);
                    // Redirect to user dashboard
                    window.location.href = '/dashboard.html';
                }
            } catch (error) {
                console.error('Error impersonating user:', error);
                showAlert('error', error.message || 'Fehler beim Impersonieren des Benutzers');
            }
        }

        function showEditModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showAlert('error', 'Benutzer nicht gefunden');
                return;
            }

            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-first-name').value = user.first_name || '';
            document.getElementById('edit-last-name').value = user.last_name || '';
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-phone').value = user.phone || '';
            document.getElementById('edit-level').value = user.experience_level || 'green';

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-form').reset();
        }

        async function saveUser(event) {
            event.preventDefault();

            const userId = parseInt(document.getElementById('edit-user-id').value);
            const data = {
                first_name: document.getElementById('edit-first-name').value.trim(),
                last_name: document.getElementById('edit-last-name').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                phone: document.getElementById('edit-phone').value.trim() || null,
                experience_level: document.getElementById('edit-level').value
            };

            try {
                await api.adminUpdateUser(userId, data);
                showAlert('success', 'Benutzer erfolgreich aktualisiert');
                closeEditModal();
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('error', error.message || 'Fehler beim Aktualisieren des Benutzers');
            }
        }

        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeEditModal();
                closeCreateModal();
                closeDeleteModal();
            }
        });

        // Create User Modal Functions
        function showCreateModal() {
            // Show admin checkbox only for Super Admins
            if (currentUser && currentUser.is_super_admin) {
                document.getElementById('create-admin-group').style.display = 'block';
            } else {
                document.getElementById('create-admin-group').style.display = 'none';
            }
            document.getElementById('create-modal').style.display = 'flex';
        }

        function closeCreateModal() {
            document.getElementById('create-modal').style.display = 'none';
            document.getElementById('create-form').reset();
            document.getElementById('create-admin-group').style.display = 'none';
        }

        async function createUser(event) {
            event.preventDefault();

            const data = {
                first_name: document.getElementById('create-first-name').value.trim(),
                last_name: document.getElementById('create-last-name').value.trim(),
                email: document.getElementById('create-email').value.trim(),
                phone: document.getElementById('create-phone').value.trim() || null,
                experience_level: document.getElementById('create-level').value,
                is_admin: document.getElementById('create-is-admin').checked
            };

            try {
                await api.createUser(data);
                showAlert('success', 'Benutzer erfolgreich erstellt. Tempor√§res Passwort wurde per E-Mail gesendet.');
                closeCreateModal();
                loadUsers();
            } catch (error) {
                console.error('Error creating user:', error);
                showAlert('error', error.message || 'Fehler beim Erstellen des Benutzers');
            }
        }

        // Delete User Modal Functions (Super-Admin only)
        function showDeleteModal(userId, userName) {
            document.getElementById('delete-user-id').value = userId;
            document.getElementById('delete-user-name').textContent = userName;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
            document.getElementById('delete-user-id').value = '';
            document.getElementById('delete-user-name').textContent = '';
        }

        async function confirmDeleteUser() {
            const userId = parseInt(document.getElementById('delete-user-id').value);
            if (!userId) {
                showAlert('error', 'Kein Benutzer ausgew√§hlt');
                return;
            }

            try {
                await api.deleteUser(userId);
                showAlert('success', 'Benutzer erfolgreich gel√∂scht');
                closeDeleteModal();
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                showAlert('error', error.message || 'Fehler beim L√∂schen des Benutzers');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>

    <style>
        /* Badge styles for consistent alignment */
        .badge-status,
        .badge-level,
        .badge-super-admin,
        .badge-admin,
        .badge-user {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            font-size: 0.75rem;
            line-height: 1;
            border-radius: var(--border-radius);
            white-space: nowrap;
        }

        .badge-status.alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-status.alert-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .badge-level.green {
            background-color: #82b965;
            color: white;
        }

        .badge-level.orange {
            background-color: #ff9800;
            color: white;
        }

        .badge-level.blue {
            background-color: #2196f3;
            color: white;
        }

        .badge-super-admin {
            background-color: #d32f2f;
            color: white;
            font-weight: bold;
        }

        .badge-admin {
            background-color: #1976d2;
            color: white;
            font-weight: bold;
        }

        .badge-user {
            color: #666;
            background-color: #f5f5f5;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }
    </style>
</body>
</html>
