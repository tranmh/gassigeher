<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benutzerverwaltung - Gassigeher Admin</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
    <header>
        <div class="container">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
            <a href="/" class="logo">üêï Gassigeher Admin</a>
            <nav id="main-nav">
                <ul>
                    <li><a href="/admin-dashboard.html" data-i18n="admin_dashboard.title">Dashboard</a></li>
                    <li><a href="/admin-dogs.html" data-i18n="dogs.manage_dogs">Hunde</a></li>
                    <li class="nav-dropdown">
                        <a href="#">Buchungen</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-bookings.html">üìÖ Alle Buchungen</a>
                            <a href="/admin-booking-approvals.html">‚úì Genehmigungen</a>
                            <a href="/admin-booking-times.html">‚è∞ Buchungszeiten</a>
                            <a href="/admin-blocked-dates.html">üö´ Gesperrte Tage</a>
                        </div>
                    </li>
                    <li class="nav-dropdown">
                        <a href="#">Benutzer</a>
                        <div class="nav-dropdown-menu">
                            <a href="/admin-users.html">üë• Alle Benutzer</a>
                            <a href="/admin-experience-requests.html">‚≠ê Level-Anfragen</a>
                            <a href="/admin-reactivation-requests.html">üîÑ Reaktivierungen</a>
                        </div>
                    </li>
                    <li><a href="/admin-settings.html" data-i18n="admin_dashboard.system_settings">Einstellungen</a></li>
                    <li><a href="/dashboard.html" class="area-switcher" data-i18n="nav.user_area">üë§ Benutzer-Bereich</a></li>
                    <li><a href="#" onclick="api.logout()" data-i18n="nav.logout">Abmelden</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="nav-overlay" id="nav-overlay" onclick="toggleMenu()"></div>

    <main style="padding: 40px 0;">
        <div class="container">
            <h1 data-i18n="users.title">Benutzerverwaltung</h1>

            <div id="alert-container"></div>

            <!-- Filters -->
            <div class="filter-bar">
                <h3 style="margin-bottom: 15px;">Filter</h3>
                <div class="filter-row">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Status</label>
                        <select id="filter-status">
                            <option value="">Alle</option>
                            <option value="active" data-i18n="users.status_active">Aktiv</option>
                            <option value="inactive" data-i18n="users.status_inactive">Inaktiv</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="applyFilters()" data-i18n="common.apply">Anwenden</button>
                </div>
            </div>

            <!-- Users List -->
            <div id="users-list"></div>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Benutzer bearbeiten</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form" onsubmit="saveUser(event)">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label for="edit-first-name">Vorname *</label>
                    <input type="text" id="edit-first-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-last-name">Nachname *</label>
                    <input type="text" id="edit-last-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">E-Mail *</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="form-group">
                    <label for="edit-phone">Telefon</label>
                    <input type="tel" id="edit-phone">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Abbrechen</button>
                    <button type="submit" class="btn">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/logo-banner.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/i18n.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sanitize.js"></script>
    <script>
        let users = [];
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!api.isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }

            // Check if user is admin
            try {
                currentUser = await api.getMe();
                if (!currentUser.is_admin) {
                    alert('Zugriff verweigert: Diese Seite ist nur f√ºr Administratoren zug√§nglich.');
                    window.location.href = '/dashboard.html';
                    return;
                }
            } catch (error) {
                console.error('Failed to verify admin status:', error);
                window.location.href = '/dashboard.html';
                return;
            }

            await window.i18n.load();

            // Explicitly update all translations after load
            console.log('i18n loaded, updating translations...');
            window.i18n.updateElement(document.body);

            loadUsers();
        });

        async function loadUsers() {
            try {
                const filterStatus = document.getElementById('filter-status').value;
                let activeOnly = null;
                if (filterStatus === 'active') activeOnly = true;
                if (filterStatus === 'inactive') activeOnly = false;

                users = await api.getUsers(activeOnly);
                renderUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Laden der Benutzer');
            }
        }

        function applyFilters() {
            loadUsers();
        }

        function renderUsers() {
            const container = document.getElementById('users-list');

            if (users.length === 0) {
                container.innerHTML = '<div class="card"><p>Keine Benutzer gefunden</p></div>';
                return;
            }

            container.innerHTML = users.map(user => {
                const statusClass = user.is_active ? 'alert-success' : 'alert-error';
                const statusLabel = user.is_active ? 'Aktiv' : 'Inaktiv';
                const levelLabel = getLevelLabel(user.experience_level);

                // Sanitize user data to prevent XSS
                const safeFirstName = sanitizeHTML(user.first_name || '');
                const safeLastName = sanitizeHTML(user.last_name || '');
                const safeName = `${safeFirstName} ${safeLastName}`.trim();
                const safeEmail = sanitizeHTML(user.email || 'N/A');
                const safePhone = sanitizeHTML(user.phone || 'N/A');
                const safeReason = user.deactivation_reason ? sanitizeHTML(user.deactivation_reason) : '';

                // Determine role badge
                let roleBadge = '';
                if (user.is_super_admin) {
                    roleBadge = '<span class="badge-super-admin">Super Admin</span>';
                } else if (user.is_admin) {
                    roleBadge = '<span class="badge-admin">Admin</span>';
                } else {
                    roleBadge = '<span style="color: #666;">Benutzer</span>';
                }

                return `
                    <div class="card" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${safeName}</h4>
                                    <span class="alert ${statusClass}" style="padding: 4px 12px; font-size: 0.8rem; margin: 0;">${statusLabel}</span>
                                    <span class="dog-category-badge ${user.experience_level}" style="font-size: 0.8rem;">${levelLabel}</span>
                                    ${roleBadge}
                                </div>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>E-Mail:</strong> ${safeEmail}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Telefon:</strong> ${safePhone}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Letzte Aktivit√§t:</strong> ${user.last_activity_at ? new Date(user.last_activity_at).toLocaleDateString('de-DE') : 'N/A'}
                                </p>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>Mitglied seit:</strong> ${new Date(user.created_at).toLocaleDateString('de-DE')}
                                </p>
                                ${user.deactivated_at && user.deactivation_reason ? `
                                    <p style="margin: 10px 0; padding: 10px; background: #fff3cd; border-radius: 4px;">
                                        <strong>Deaktivierungsgrund:</strong> ${safeReason}
                                    </p>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 5px; flex-direction: column; min-width: 150px;">
                                ${!user.is_deleted ? `
                                    <button class="btn btn-secondary btn-sm" onclick="showEditModal(${user.id})">Bearbeiten</button>
                                ` : ''}
                                ${!user.is_admin && !user.is_super_admin && user.is_active ? `
                                    <button class="btn btn-danger btn-sm" onclick="deactivateUser(${user.id})">Deaktivieren</button>
                                ` : user.is_active && !user.is_super_admin ? `
                                    <button class="btn btn-sm" onclick="activateUser(${user.id})">Aktivieren</button>
                                ` : !user.is_active ? `
                                    <button class="btn btn-sm" onclick="activateUser(${user.id})">Aktivieren</button>
                                ` : ''}

                                ${currentUser && currentUser.is_super_admin && !user.is_super_admin ? `
                                    ${user.is_admin ? `
                                        <button class="btn btn-warning btn-sm" onclick="demoteAdmin(${user.id}, '${safeName.replace(/'/g, "\\'")}')">Admin entfernen</button>
                                    ` : `
                                        <button class="btn btn-secondary btn-sm" onclick="promoteToAdmin(${user.id}, '${safeName.replace(/'/g, "\\'")}')">Zu Admin ernennen</button>
                                    `}
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getLevelLabel(level) {
            const labels = { green: 'Gr√ºn', blue: 'Blau', orange: 'Orange' };
            return labels[level] || level;
        }

        async function deactivateUser(id) {
            const reason = prompt('Grund f√ºr die Deaktivierung:');
            if (!reason) return;

            if (!confirm('Sind Sie sicher, dass Sie diesen Benutzer deaktivieren m√∂chten?')) {
                return;
            }

            try {
                await api.deactivateUser(id, reason);
                showAlert('success', 'Benutzer deaktiviert');
                loadUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Deaktivieren');
            }
        }

        async function activateUser(id) {
            const message = prompt('Optional: Nachricht an den Benutzer:');

            if (!confirm('M√∂chten Sie diesen Benutzer aktivieren?')) {
                return;
            }

            try {
                await api.activateUser(id, message || null);
                showAlert('success', 'Benutzer aktiviert');
                loadUsers();
            } catch (error) {
                showAlert('error', error.message || 'Fehler beim Aktivieren');
            }
        }

        async function promoteToAdmin(userId, userName) {
            if (!confirm(`M√∂chten Sie ${userName} wirklich zum Admin ernennen?\n\nAdmins haben Zugriff auf alle Verwaltungsfunktionen.`)) {
                return;
            }

            try {
                const result = await api.promoteToAdmin(userId);
                showAlert('success', `${userName} wurde erfolgreich zum Admin ernannt.`);
                loadUsers();
            } catch (error) {
                console.error('Error promoting user:', error);
                showAlert('error', error.message || 'Fehler beim Ernennen zum Admin');
            }
        }

        async function demoteAdmin(userId, userName) {
            if (!confirm(`M√∂chten Sie ${userName} wirklich die Admin-Rechte entziehen?\n\nDer Benutzer wird zu einem normalen Benutzer herabgestuft.`)) {
                return;
            }

            try {
                const result = await api.demoteAdmin(userId);
                showAlert('success', `Admin-Rechte von ${userName} wurden erfolgreich entzogen.`);
                loadUsers();
            } catch (error) {
                console.error('Error demoting admin:', error);
                showAlert('error', error.message || 'Fehler beim Entziehen der Admin-Rechte');
            }
        }

        function showEditModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showAlert('error', 'Benutzer nicht gefunden');
                return;
            }

            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-first-name').value = user.first_name || '';
            document.getElementById('edit-last-name').value = user.last_name || '';
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-phone').value = user.phone || '';

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-form').reset();
        }

        async function saveUser(event) {
            event.preventDefault();

            const userId = parseInt(document.getElementById('edit-user-id').value);
            const data = {
                first_name: document.getElementById('edit-first-name').value.trim(),
                last_name: document.getElementById('edit-last-name').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                phone: document.getElementById('edit-phone').value.trim() || null
            };

            try {
                await api.adminUpdateUser(userId, data);
                showAlert('success', 'Benutzer erfolgreich aktualisiert');
                closeEditModal();
                loadUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('error', error.message || 'Fehler beim Aktualisieren des Benutzers');
            }
        }

        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeEditModal();
            }
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>

    <style>
        .badge-super-admin {
            background-color: #d32f2f;
            color: white;
            padding: 4px 12px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-admin {
            background-color: #1976d2;
            color: white;
            padding: 4px 12px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</body>
</html>
